# NUCLEO_F401RE_SIMPLE_OSCILLOSCOPE

以下のブログで紹介している簡易オシロスコープのファームウェアを公開します。

[STM32マイコンで簡易オシロスコープを自作](https://mzmlab.hatenablog.com/entry/stm32-oscilloscope)


- [1. 簡易オシロスコープの仕様](#1-簡易オシロスコープの仕様)
- [2. 開発環境](#2-開発環境)
- [3. マイコンのピンアサイン](#3-マイコンのピンアサイン)
  - [3.1. TFT液晶MSP2807との接続](#31-tft液晶msp2807との接続)
  - [3.2. 入力チャンネル](#32-入力チャンネル)
  - [3.3. テスト用信号](#33-テスト用信号)
- [4. ソフトウェア設計概要](#4-ソフトウェア設計概要)
  - [4.1. サンプリング機能](#41-サンプリング機能)
  - [4.2. トリガ機能](#42-トリガ機能)
  - [4.3. ディスプレイ表示機能](#43-ディスプレイ表示機能)
- [5. 今後の展望](#5-今後の展望)


## 1. 簡易オシロスコープの仕様

簡易なオシロスコープということで、仕様は次の通りです。

* チャンネル数 : 1ch　(立ち上がりエッジでトリガ可)
* 周波数帯域 : 40kHz
* A/D分解能 : 12bit
* サンプリング周波数 : 200kS/s (※1)
* レコード長 : 300サンプル
* 最高入力電圧 : 3.3V (※2)

STM32マイコンの評価ボード **Nucleo Board STM32F401**の機能だけで上記仕様を実現しています。
[ブログ](https://mzmlab.hatenablog.com/entry/stm32-oscilloscope)で写真と動画も載せていますが、ブレッドボードにNucleoボードとTFT液晶(MSP2807)をセットするだけで動作を確認できます。  

※1 自分の用途では200kS/sで十分なのでそのように実装しましたが、ADCの性能的には1MS/s以上にすることも可能だと思います。

※2 マイコンのADCポートに直接信号を入力しているため、<u>マイコンの電源電圧3.3Vを超える信号は入力できません</u>。本来は入力回路も適切に設計する必要がありますが、そこは追々勉強していきたいと思います...


## 2. 開発環境
* 開発用PC ・・・ OS: Windows10 64bit
* 統合開発環境 ・・・ STM32CubeIDE Version:1.8.0

## 3. マイコンのピンアサイン

### 3.1. TFT液晶MSP2807との接続

■ Nucleo CN5 (digital)

|Pin|MCU pin|Function|MSP2807|
|---|---|---|---|
|GND|-|Ground|GND|
|D13|PA5|SPI1_SCK|SCK|
|D12|PA6|SPI1_MISO|SDO(MISO)|
|D11|PA7|SPI1_MOSI|SDI(MOSI)|
|D10|PB6|-|CS|
|D9|PC7|-|DC/RS|
|D8|PA9|-|RESET|


■ Nucleo CN6 (power)

|Pin|MCU pin|Function|MSP2807|
|---|---|---|---|
|+3V3|-|3.3V output|LED (バックライト)|
|+5V|-|5V output|VCC|

※バックライトはとりあえず3.3Vに接続していますが、GPIOに接続すればソフトウェアでバックライトをON/OFFできます。  

### 3.2. 入力チャンネル

■ Nucleo CN8 (analog)  

|Pin|MCU pin|Function|用途|
|---|---|---|---|
|A0|PA0|ADC1_0|入力チャンネル|

### 3.3. テスト用信号

■ Nucleo CN9

|Pin|MCU pin|Function|用途|
|---|---|---|---|
|D6|PB10|TIM2_CH3|テスト用信号(10kHz矩形波)|


## 4. ソフトウェア設計概要

以下、ソフトウェア設計のポイントになる部分（苦労した部分^^;）について記載します。

### 4.1. サンプリング機能
5μs (200kHz)の正確な周期でAD変換し、ADデータをメモリ(RAM)に時系列に格納するにはどうすればよいかという問題です。5μs周期の処理はタイマ割り込みを使えば容易に実現できますが、割り込みルーチンの中でAD変換、メモリ格納を行っていては、5μsの内に処理が終わらないかもしれません。

そこで、次の図のように、タイマ、ADC、DMAを連携させて、サンプリングの動作をすべてハードウェアにやらせることにします。すなわち、タイマー割り込みをトリガにしてAD変換を起動し、AD変換終了をトリガにしてDMAでADデータをRAMに転送します。また、DMAをサーキュラモードにすることで、図のように、指定した転送数のメモリ転送を無限に繰り返すことができます（繰り返しにより、先頭データから上書きされていく）。


### 4.2. トリガ機能
トリガ機能とは、入力信号が閾値を超えたらサンプリング（もしくは画面更新）を停止する機能です。次の図のように、ADCのアナログウォッチドッグ機能（AD変換結果が閾値を超えたら割り込みを発生）とタイマを利用して実現しました。



### 4.3. ディスプレイ表示機能
サンプリングデータをリアルタイム（と言っても10kHz程度）でディスプレイにグラフ表示します。

MSP2807のインタフェースはSPIですが、MSP2807のサンプルプログラムをそのまま使うと、ソフトウェアで1ドットずつRGBデータをSPI送信データレジスタに書き込むため、ディスプレイの更新が非常に遅くなります（ディスプレイが上側から下側に更新されていくのが目で見える程遅いです）。そのため、全体（320x240）のRGBデータを一旦RAM上で作成し、DMAでSPI送信データレジスタに転送するようにして高速化しています。


## 5. 今後の展望
* TFT液晶MSP2807はタッチパネル搭載なので、タッチ操作でいろいろな設定を変更できるようにしたい。例えば、  
  * 1 divあたりの電圧（縦軸）、1 divあたりの時間（横軸）
  * トリガの閾値
* 入力回路をきちんと設計して、箱に入れて、本当に使えるものにしたい。
